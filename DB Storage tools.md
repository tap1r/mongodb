# DB storage tools

## Storage engine usage reporting

This script is primarily designed to evaluate disk utilisation (including "_fragmentation_") for DB maintainance and for capacity planning tasks.

The [dbstats.js](src/dbstats.js) script provides a basic tabular report of DB internal storage and some dervied metrics:

* Data size (uncompressed)
* Storage size (on disk)
* Document count
* Free blocks (reclaimable space)
* Compression

### Using _dbstats.js_

Sample syntax to run against on the _mongo_ shell:

```bash
mongo [+connection options] --quiet dbstats.js
```

### Sample output

```text
============================================================================================================================
Database: admin
----------------------------------------------------------------------------------------------------------------------------
Collection(s)                              Data size    Size on disk    Object count     Free blocks (reuse)     Compression
----------------------------------------------------------------------------------------------------------------------------
 system.keys                                 0.00 MB         0.04 MB               2         0.02 MB (44.4%)          0.01:1
----------------------------------------------------------------------------------------------------------------------------
 system.version                              0.00 MB         0.03 MB               1         0.01 MB (37.5%)          0.00:1
----------------------------------------------------------------------------------------------------------------------------
View(s)                             
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                        0.00 MB         0.07 MB               3         0.03 MB (41.2%)          0.01:1
Indexes subtotal:                                            0.07 MB                         0.03 MB (41.2%)
============================================================================================================================

============================================================================================================================
Database: config
----------------------------------------------------------------------------------------------------------------------------
Collection(s)                              Data size    Size on disk    Object count     Free blocks (reuse)     Compression
----------------------------------------------------------------------------------------------------------------------------
 system.indexBuilds                          0.00 MB         0.02 MB               0         0.00 MB (16.7%)          0.00:1
----------------------------------------------------------------------------------------------------------------------------
 system.sessions                             0.00 MB         0.01 MB               0         0.00 MB (33.3%)          0.00:1
----------------------------------------------------------------------------------------------------------------------------
 transactions                                0.00 MB         0.00 MB               0         0.00 MB  (0.0%)          0.00:1
----------------------------------------------------------------------------------------------------------------------------
View(s)                             
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                        0.00 MB         0.04 MB               0         0.01 MB (20.0%)          0.00:1
Indexes subtotal:                                            0.05 MB                         0.01 MB (23.1%)
============================================================================================================================

============================================================================================================================
Database: database
----------------------------------------------------------------------------------------------------------------------------
Collection(s)                              Data size    Size on disk    Object count     Free blocks (reuse)     Compression
----------------------------------------------------------------------------------------------------------------------------
 collection                                  3.23 MB         1.58 MB            6157         0.00 MB  (0.0%)          2.04:1
----------------------------------------------------------------------------------------------------------------------------
 system.views                                0.00 MB         0.02 MB               1         0.00 MB  (0.0%)          0.00:1
----------------------------------------------------------------------------------------------------------------------------
View(s)                             
----------------------------------------------------------------------------------------------------------------------------
 myView                             
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                        3.23 MB         1.60 MB            6158         0.00 MB  (0.0%)          2.02:1
Indexes subtotal:                                            0.64 MB                         0.00 MB  (0.0%)
============================================================================================================================

============================================================================================================================
Database: local
----------------------------------------------------------------------------------------------------------------------------
Collection(s)                              Data size    Size on disk    Object count     Free blocks (reuse)     Compression
----------------------------------------------------------------------------------------------------------------------------
 oplog.rs                                  145.00 MB        65.88 MB          238064         2.30 MB  (3.5%)          2.28:1
----------------------------------------------------------------------------------------------------------------------------
 replset.election                            0.00 MB         0.04 MB               1         0.02 MB (44.4%)          0.00:1
----------------------------------------------------------------------------------------------------------------------------
 replset.initialSyncId                       0.00 MB         0.03 MB               1         0.01 MB (37.5%)          0.00:1
----------------------------------------------------------------------------------------------------------------------------
 replset.minvalid                            0.00 MB         0.04 MB               1         0.02 MB (44.4%)          0.00:1
----------------------------------------------------------------------------------------------------------------------------
 replset.oplogTruncateAfterPoint             0.00 MB         0.04 MB               1         0.02 MB (44.4%)          0.00:1
----------------------------------------------------------------------------------------------------------------------------
 startup_log                                 0.01 MB         0.04 MB               2         0.02 MB (44.4%)          0.30:1
----------------------------------------------------------------------------------------------------------------------------
 system.replset                              0.00 MB         0.04 MB               1         0.02 MB (44.4%)          0.04:1
----------------------------------------------------------------------------------------------------------------------------
 system.rollback.id                          0.00 MB         0.03 MB               1         0.01 MB (37.5%)          0.00:1
----------------------------------------------------------------------------------------------------------------------------
View(s)                             
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                      145.01 MB        66.12 MB          238072         2.41 MB  (3.6%)          2.28:1
Indexes subtotal:                                            0.22 MB                         0.09 MB (38.6%)
============================================================================================================================

============================================================================================================================
dbPath totals                              Data size    Size on disk    Object count     Free blocks (reuse)     Compression
----------------------------------------------------------------------------------------------------------------------------
All DBs:                                   148.24 MB        67.82 MB          244233         2.44 MB  (3.6%)          2.27:1
All indexes:                                                 0.98 MB                         0.13 MB (12.7%)
============================================================================================================================
```

## WiredTiger internals

This script is designed to enumerate the _`.wt`_ files in the _`$dbPath`_ and provide a visualisation of the storage engine page structures and layout.

TBA: [wtfrag.py](src/wtfrag.py)

### Using _wtfrag.py_

```bash
./wtfrag.py
```
