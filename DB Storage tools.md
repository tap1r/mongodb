# DB storage tools

## Storage engine usage reporting

This script is primarily designed to evaluate disk utilisation (including "_fragmentation_") for DB maintainance and for capacity planning tasks.

The [dbstats.js](src/dbstats.js) script (and [mdblib.js](src/mdblib.js) dependency) provides a basic tabular report of DB internal storage and some dervied metrics:

* Data size (uncompressed)
* Storage size (on disk)
* Document count
* Orphaned document count
* Free blocks (reclaimable/reusable space)
* Compression statistics

### Installing _dbstats.js_

Retrieve fresh versions of both the _dbstats.js_ and _mdblib.js_ scripts:

```bash
curl --remote-name-all -fsSL https://raw.githubusercontent.com/tap1r/mongodb-scripts/master/src/{dbstats.js,mdblib.js}
```

### Using _dbstats.js_

Sample syntax to run against either of the _mongo_ or _mongosh_ shells:

```bash
[mongo|mongosh] [connection options] --quiet dbstats.js
```

### Prerequisites

1. Add [mdblib.js](src/mdblib.js) dependency to the `cwd` or `$MDBLIB` path
2. Ensure _authorized_ users have the following minimum required roles `readAnyDatabase@admin` and `clusterMonitor@admin`

   In the Atlas UI this translates as:
   * Built-in Role: _Only read any database_
   * Specific Privileges: _clusterMonitor_
 
   Or:
   * Custom role:
     * Global Actions and Roles 
       - Built-In Roles
         - _clusterMonitor_
         - _readAnyDatabase_

### Sample output

```text
======================================================================================================================================
Database: admin                               Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections:         0
--------------------------------------------------------------------------------------------------------------------------------------
Views:               0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal: 4                          0.01 MB           0.1:1        0.14 MB        0.06 MB (44.4%)             32         0
Indexes subtotal:    6                                                         0.21 MB           0 MB    (0%)
======================================================================================================================================

======================================================================================================================================
Database: config                              Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections:         6
 -------------------------------------------------------------------------------------------------------------------------------------
 external_validation_keys                          0 MB      0:1 snappy           0 MB           0 MB    (0%)              0         0
 -------------------------------------------------------------------------------------------------------------------------------------
 image_collection                                  0 MB      0:1 snappy           0 MB           0 MB    (0%)              0         0
 -------------------------------------------------------------------------------------------------------------------------------------
 tenantMigrationDonors                             0 MB      0:1 snappy           0 MB           0 MB    (0%)              0         0
 -------------------------------------------------------------------------------------------------------------------------------------
 tenantMigrationRecipients                         0 MB      0:1 snappy           0 MB           0 MB    (0%)              0         0
 -------------------------------------------------------------------------------------------------------------------------------------
 transactions                                      0 MB      0:1 snappy        0.03 MB        0.02 MB   (75%)              0         0
 -------------------------------------------------------------------------------------------------------------------------------------
 user_writes_critical_sections                     0 MB      0:1 snappy        0.03 MB        0.01 MB (37.5%)              0         0
--------------------------------------------------------------------------------------------------------------------------------------
Views:               0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal: 9                             0 MB          0.11:1        0.13 MB        0.09 MB (69.7%)             31         0
Indexes subtotal:    13                                                        0.21 MB        0.04 MB (18.9%)
======================================================================================================================================

======================================================================================================================================
Database: database                            Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections:         1
 -------------------------------------------------------------------------------------------------------------------------------------
 collection                                   171.96 MB     2.47:1 zstd       70.73 MB        1.13 MB  (1.6%)         188899         0
--------------------------------------------------------------------------------------------------------------------------------------
Views:               1
--------------------------------------------------------------------------------------------------------------------------------------
 myView
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal: 2                        171.96 MB          2.52:1       70.43 MB        2.32 MB  (3.3%)         188900         0
Indexes subtotal:    20                                                      201.06 MB      104.64 MB   (52%)
======================================================================================================================================

======================================================================================================================================
Database: encryption                          Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections:         1
 -------------------------------------------------------------------------------------------------------------------------------------
 __keyVault                                        0 MB      0:1 snappy           0 MB           0 MB    (0%)              0         0
--------------------------------------------------------------------------------------------------------------------------------------
Views:               0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal: 1                             0 MB             0:1           0 MB           0 MB    (0%)              0         0
Indexes subtotal:    2                                                         0.01 MB           0 MB    (0%)
======================================================================================================================================

======================================================================================================================================
Database: local                               Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections:         3
 -------------------------------------------------------------------------------------------------------------------------------------
 clustermanager                                    0 MB   0.01:1 snappy        0.04 MB        0.02 MB (44.4%)              1         0
 -------------------------------------------------------------------------------------------------------------------------------------
 oplog.rs                                      984.6 MB   2.18:1 snappy      543.41 MB       90.95 MB (16.7%)        1772348         0
 -------------------------------------------------------------------------------------------------------------------------------------
 startup_log                                    0.33 MB   5.67:1 snappy        0.08 MB        0.02 MB (28.6%)             96         0
--------------------------------------------------------------------------------------------------------------------------------------
Views:               1
--------------------------------------------------------------------------------------------------------------------------------------
 system.tenantMigration.oplogView        
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal: 10                       979.46 MB          2.78:1      528.93 MB      176.82 MB (33.4%)        1851996         0
Indexes subtotal:    9                                                         0.27 MB        0.03 MB   (10%)
======================================================================================================================================

======================================================================================================================================
Database: sample_airbnb                       Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections:         2
 -------------------------------------------------------------------------------------------------------------------------------------
 listingsAndReviews                            89.99 MB   1.73:1 snappy       51.93 MB        0.04 MB  (0.1%)           5555         0
 -------------------------------------------------------------------------------------------------------------------------------------
 listingsAndReviewsCSV                         89.99 MB   1.74:1 snappy       51.65 MB        0.05 MB  (0.1%)           5555         0
--------------------------------------------------------------------------------------------------------------------------------------
Views:               0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal: 2                        179.98 MB          1.74:1      112.83 MB        9.45 MB  (8.4%)          11110         0
Indexes subtotal:    5                                                         0.74 MB        0.06 MB  (7.9%)
======================================================================================================================================

======================================================================================================================================
Database: sample_geospatial                   Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections:         1
 -------------------------------------------------------------------------------------------------------------------------------------
 shipwrecks                                     3.48 MB   4.88:1 snappy        0.73 MB        0.01 MB  (1.6%)          11095         0
--------------------------------------------------------------------------------------------------------------------------------------
Views:               0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal: 1                          3.48 MB          5.54:1        0.65 MB        0.02 MB  (3.6%)          11095         0
Indexes subtotal:    2                                                         0.32 MB        0.02 MB  (7.3%)
======================================================================================================================================

======================================================================================================================================
Database: sample_mflix                        Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections:         5
 -------------------------------------------------------------------------------------------------------------------------------------
 comments                                      13.63 MB    1.8:1 snappy        7.58 MB        0.01 MB  (0.2%)          50304         0
 -------------------------------------------------------------------------------------------------------------------------------------
 movies                                         35.9 MB   1.72:1 snappy       21.17 MB        0.32 MB  (1.5%)          23539         0
 -------------------------------------------------------------------------------------------------------------------------------------
 sessions                                          0 MB   0.03:1 snappy        0.03 MB        0.01 MB (37.5%)              1         0
 -------------------------------------------------------------------------------------------------------------------------------------
 theaters                                       0.33 MB    2.2:1 snappy        0.16 MB        0.01 MB  (7.1%)           1564         0
 -------------------------------------------------------------------------------------------------------------------------------------
 users                                          0.03 MB   0.83:1 snappy        0.05 MB        0.01 MB   (25%)            185         0
--------------------------------------------------------------------------------------------------------------------------------------
Views:               0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal: 5                          49.9 MB          1.78:1       28.52 MB         0.5 MB  (1.7%)          75593         0
Indexes subtotal:    9                                                        15.39 MB        0.11 MB  (0.7%)
======================================================================================================================================

======================================================================================================================================
Database: sample_supplies                     Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections:         1
 -------------------------------------------------------------------------------------------------------------------------------------
 sales                                          4.13 MB    4.7:1 snappy        0.89 MB        0.01 MB  (1.3%)           5000         0
--------------------------------------------------------------------------------------------------------------------------------------
Views:               0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal: 1                          4.13 MB          4.02:1        1.05 MB        0.02 MB  (2.2%)           5000         0
Indexes subtotal:    1                                                         0.22 MB        0.01 MB  (5.3%)
======================================================================================================================================

======================================================================================================================================
Database: sample_training                     Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections:         9
 -------------------------------------------------------------------------------------------------------------------------------------
 companies                                     34.79 MB   2.22:1 snappy        15.7 MB        0.01 MB  (0.1%)           9500         0
 -------------------------------------------------------------------------------------------------------------------------------------
 grades                                        22.22 MB   3.12:1 snappy        7.15 MB        0.03 MB  (0.4%)         100000         0
 -------------------------------------------------------------------------------------------------------------------------------------
 inspections                                   21.13 MB   2.39:1 snappy        8.86 MB        0.04 MB  (0.4%)          80047         0
 -------------------------------------------------------------------------------------------------------------------------------------
 posts                                         16.64 MB   3.98:1 snappy        4.19 MB        0.01 MB  (0.3%)            500         0
 -------------------------------------------------------------------------------------------------------------------------------------
 routes                                        11.76 MB   5.32:1 snappy        2.23 MB        0.02 MB    (1%)          66985         0
 -------------------------------------------------------------------------------------------------------------------------------------
 stories                                        9.62 MB   2.11:1 snappy        4.58 MB        0.01 MB  (0.3%)           9842         0
 -------------------------------------------------------------------------------------------------------------------------------------
 trips                                           4.2 MB   3.56:1 snappy        1.19 MB        0.01 MB    (1%)          10000         0
 -------------------------------------------------------------------------------------------------------------------------------------
 tweets                                        39.39 MB   2.48:1 snappy       15.93 MB        0.04 MB  (0.2%)          24832         0
 -------------------------------------------------------------------------------------------------------------------------------------
 zips                                           3.13 MB   2.04:1 snappy        2.23 MB         0.7 MB (31.1%)          29470         0
--------------------------------------------------------------------------------------------------------------------------------------
Views:               0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal: 9                        162.88 MB          2.69:1       61.58 MB           1 MB  (1.6%)         331176         0
Indexes subtotal:    10                                                         9.6 MB        0.14 MB  (1.5%)
======================================================================================================================================

======================================================================================================================================
Database: sample_weatherdata                  Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections:         1
 -------------------------------------------------------------------------------------------------------------------------------------
 data                                          16.15 MB   5.55:1 snappy        2.93 MB        0.02 MB  (0.5%)          10000         0
--------------------------------------------------------------------------------------------------------------------------------------
Views:               0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal: 1                         16.15 MB           6.7:1        2.44 MB        0.03 MB  (1.1%)          10000         0
Indexes subtotal:    1                                                         0.16 MB        0.01 MB  (7.3%)
======================================================================================================================================

======================================================================================================================================
dbPath totals                                 Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
All DBs:                                     1567.95 MB          2.54:1      806.71 MB       190.3 MB (23.6%)        2484933         0
All indexes:                                                                  228.2 MB      105.07 MB   (46%)
======================================================================================================================================
Host: hostname.example.org	Type: mongod	dbPath: /data/replset/rs1/db
======================================================================================================================================
```
