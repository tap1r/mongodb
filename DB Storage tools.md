# DB storage tools

## Storage engine usage reporting

This script is primarily designed to evaluate disk utilisation (including "_fragmentation_") for DB maintainance and for capacity planning tasks.

The [dbstats.js](src/dbstats.js) script (and [mdblib.js](src/mdblib.js) dependency) provides a basic tabular report of DB internal storage and some dervied metrics:

* Data size (uncompressed)
* Storage size (on disk)
* Document count
* Free blocks (reclaimable space)
* Compression

### Using _dbstats.js_

Sample syntax to run against either of the _mongo_ or _mongosh_ shells:

```bash
[mongo|mongosh] [connection options] --quiet dbstats.js
```

### Prerequisites

1. Add [mdblib.js](src/mdblib.js) dependency to the `cwd` or `$MDBLIB` path
2. Ensure _authorized_ users have the following minimum required roles `readAnyDatabase@admin` and `clusterMonitor@admin`

   In the Atlas UI this translates as
   * Built-in Role: Only read any database
   * Specific Privileges: clusterMonitor
   -or-
   * Custom role:
     * Global Actions and Roles 
       - Built-In Roles
         - clusterMonitor
         - readAnyDatabase

### Sample output

```text
============================================================================================================================
Database: admin                               Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collections:	0                 
----------------------------------------------------------------------------------------------------------------------------
Views:		0                      
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                           0.01 MB          0.05:1        0.14 MB        0.00 MB  (0.0%)             30
Indexes subtotal:                                                              0.21 MB        0.00 MB  (0.0%)
============================================================================================================================

============================================================================================================================
Database: config                              Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collections:	5                 
 ---------------------------------------------------------------------------------------------------------------------------
 external_validation_keys                       0.00 MB   0.00:1 snappy        0.00 MB        0.00 MB  (0.0%)              0
 ---------------------------------------------------------------------------------------------------------------------------
 image_collection                               0.00 MB   0.00:1 snappy        0.00 MB        0.00 MB  (0.0%)              0
 ---------------------------------------------------------------------------------------------------------------------------
 tenantMigrationDonors                          0.00 MB   0.00:1 snappy        0.00 MB        0.00 MB  (0.0%)              0
 ---------------------------------------------------------------------------------------------------------------------------
 tenantMigrationRecipients                      0.00 MB   0.00:1 snappy        0.00 MB        0.00 MB  (0.0%)              0
 ---------------------------------------------------------------------------------------------------------------------------
 transactions                                   0.00 MB   0.00:1 snappy        0.02 MB        0.02 MB (66.7%)              0
----------------------------------------------------------------------------------------------------------------------------
Views:		0                      
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                           0.01 MB          0.07:1        0.09 MB        0.02 MB (17.4%)             41
Indexes subtotal:                                                              0.19 MB        0.03 MB (14.6%)
============================================================================================================================

============================================================================================================================
Database: database                            Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collections:	1                 
 ---------------------------------------------------------------------------------------------------------------------------
 collection                                   171.96 MB   0.84:1   zstd      209.37 MB        4.18 MB  (2.0%)         188898
----------------------------------------------------------------------------------------------------------------------------
Views:		1                      
----------------------------------------------------------------------------------------------------------------------------
 view                                   
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                         171.96 MB          0.83:1      210.38 MB        4.18 MB  (2.0%)         188899
Indexes subtotal:                                                            330.58 MB       96.65 MB (29.2%)
============================================================================================================================

============================================================================================================================
Database: encryption                          Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collections:	1                 
 ---------------------------------------------------------------------------------------------------------------------------
 __keyVault                                     0.00 MB   0.00:1 snappy        0.00 MB        0.00 MB  (0.0%)              0
----------------------------------------------------------------------------------------------------------------------------
Views:		0                      
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                           0.00 MB          0.00:1        0.00 MB        0.00 MB  (0.0%)              0
Indexes subtotal:                                                              0.01 MB        0.00 MB  (0.0%)
============================================================================================================================

============================================================================================================================
Database: local                               Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collections:	3                 
 ---------------------------------------------------------------------------------------------------------------------------
 clustermanager                                 0.00 MB   0.01:1 snappy        0.04 MB        0.02 MB (44.4%)              1
 ---------------------------------------------------------------------------------------------------------------------------
 oplog.rs                                     982.52 MB   2.47:1 snappy      530.65 MB      132.98 MB (25.1%)        2727808
 ---------------------------------------------------------------------------------------------------------------------------
 startup_log                                    0.31 MB   5.30:1 snappy        0.09 MB        0.03 MB (31.8%)             91
----------------------------------------------------------------------------------------------------------------------------
Views:		0                      
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                         982.84 MB          2.48:1      528.93 MB      133.02 MB (25.1%)        2727377
Indexes subtotal:                                                              0.27 MB        0.03 MB (10.0%)
============================================================================================================================

============================================================================================================================
Database: sample_airbnb                       Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collections:	2                 
 ---------------------------------------------------------------------------------------------------------------------------
 listingsAndReviews                            89.99 MB   1.75:1 snappy       51.48 MB        0.06 MB  (0.1%)           5555
 ---------------------------------------------------------------------------------------------------------------------------
 listingsAndReviewsCSV                         89.99 MB   1.75:1 snappy       52.10 MB        0.79 MB  (1.5%)           5555
----------------------------------------------------------------------------------------------------------------------------
Views:		0                      
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                         179.98 MB          1.61:1      112.83 MB        0.84 MB  (0.7%)          11110
Indexes subtotal:                                                              0.74 MB        0.07 MB  (9.5%)
============================================================================================================================

============================================================================================================================
Database: sample_geospatial                   Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collections:	1                 
 ---------------------------------------------------------------------------------------------------------------------------
 shipwrecks                                     3.48 MB   4.84:1 snappy        0.73 MB        0.01 MB  (1.6%)          11095
----------------------------------------------------------------------------------------------------------------------------
Views:		0                      
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                           3.48 MB          5.43:1        0.65 MB        0.01 MB  (1.8%)          11095
Indexes subtotal:                                                              0.32 MB        0.02 MB  (7.3%)
============================================================================================================================

============================================================================================================================
Database: sample_mflix                        Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collections:	5                 
 ---------------------------------------------------------------------------------------------------------------------------
 comments                                      13.63 MB   1.88:1 snappy        7.25 MB        0.01 MB  (0.2%)          50304
 ---------------------------------------------------------------------------------------------------------------------------
 movies                                        35.90 MB   1.70:1 snappy       21.11 MB        0.02 MB  (0.1%)          23539
 ---------------------------------------------------------------------------------------------------------------------------
 sessions                                       0.00 MB   0.03:1 snappy        0.03 MB        0.01 MB (37.5%)              1
 ---------------------------------------------------------------------------------------------------------------------------
 theaters                                       0.33 MB   2.37:1 snappy        0.15 MB        0.01 MB  (7.7%)           1564
 ---------------------------------------------------------------------------------------------------------------------------
 users                                          0.03 MB   0.80:1 snappy        0.05 MB        0.01 MB (25.0%)            185
----------------------------------------------------------------------------------------------------------------------------
Views:		0                      
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                          49.90 MB          1.75:1       28.52 MB        0.07 MB  (0.2%)          75593
Indexes subtotal:                                                             15.39 MB        0.11 MB  (0.7%)
============================================================================================================================

============================================================================================================================
Database: sample_supplies                     Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collections:	1                 
 ---------------------------------------------------------------------------------------------------------------------------
 sales                                          4.13 MB   4.70:1 snappy        0.89 MB        0.01 MB  (1.3%)           5000
----------------------------------------------------------------------------------------------------------------------------
Views:		0                      
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                           4.13 MB          3.97:1        1.05 MB        0.01 MB  (1.1%)           5000
Indexes subtotal:                                                              0.22 MB        0.01 MB  (5.3%)
============================================================================================================================

============================================================================================================================
Database: sample_training                     Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collections:	9                 
 ---------------------------------------------------------------------------------------------------------------------------
 companies                                     34.79 MB   2.23:1 snappy       17.26 MB        1.66 MB  (9.6%)           9500
 ---------------------------------------------------------------------------------------------------------------------------
 grades                                        22.22 MB   3.43:1 snappy        6.53 MB        0.05 MB  (0.8%)         100000
 ---------------------------------------------------------------------------------------------------------------------------
 inspections                                   21.13 MB   2.50:1 snappy        8.49 MB        0.04 MB  (0.5%)          80047
 ---------------------------------------------------------------------------------------------------------------------------
 posts                                         16.64 MB   4.11:1 snappy        4.06 MB        0.01 MB  (0.3%)            500
 ---------------------------------------------------------------------------------------------------------------------------
 routes                                        11.76 MB   4.80:1 snappy        2.47 MB        0.02 MB  (0.8%)          66985
 ---------------------------------------------------------------------------------------------------------------------------
 stories                                        9.62 MB   2.16:1 snappy        4.48 MB        0.02 MB  (0.5%)           9842
 ---------------------------------------------------------------------------------------------------------------------------
 trips                                          4.20 MB   3.56:1 snappy        1.19 MB        0.01 MB  (1.0%)          10000
 ---------------------------------------------------------------------------------------------------------------------------
 tweets                                        39.39 MB   2.61:1 snappy       16.89 MB        1.80 MB (10.7%)          24832
 ---------------------------------------------------------------------------------------------------------------------------
 zips                                           3.13 MB   2.13:1 snappy        1.48 MB        0.01 MB  (0.8%)          29470
----------------------------------------------------------------------------------------------------------------------------
Views:		0                      
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                         162.88 MB          2.81:1       61.58 MB        3.63 MB  (5.9%)         331176
Indexes subtotal:                                                              9.60 MB        0.20 MB  (2.1%)
============================================================================================================================

============================================================================================================================
Database: sample_weatherdata                  Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collections:	1                 
 ---------------------------------------------------------------------------------------------------------------------------
 data                                          16.15 MB   6.89:1 snappy        2.36 MB        0.01 MB  (0.5%)          10000
----------------------------------------------------------------------------------------------------------------------------
Views:		0                      
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                          16.15 MB          6.66:1        2.44 MB        0.01 MB  (0.5%)          10000
Indexes subtotal:                                                              0.16 MB        0.01 MB  (7.3%)
============================================================================================================================

============================================================================================================================
dbPath totals                                 Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
All DBs:                                     1571.33 MB          1.95:1      946.62 MB      141.79 MB (15.0%)        3360321
All indexes:                                                                 357.69 MB       97.13 MB (27.2%)
============================================================================================================================
Hostname: hostname.example.org 	Type: mongod 	dbPath: /data/replset/rs1/db
============================================================================================================================
```
