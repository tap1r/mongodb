# DB storage tools

## Storage engine usage reporting

This script is primarily designed to evaluate disk utilisation (including "_fragmentation_") for DB maintainance and for capacity planning tasks.

The [dbstats.js](src/dbstats.js) script provides a basic tabular report of DB internal storage and some dervied metrics:

* Data size (uncompressed)
* Storage size (on disk)
* Document count
* Free blocks (reclaimable space)
* Compression

### Using _dbstats.js_

Sample syntax to run against on the _mongo_ shell:

```bash
mongo [connection options] --quiet dbstats.js
```

### Sample output

```text
============================================================================================================================
Database: admin                               Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collection(s):	2                        
----------------------------------------------------------------------------------------------------------------------------
 system.keys                                    0.00 MB   0.01:1 snappy        0.03 MB        0.01 MB (37.5%)              2
----------------------------------------------------------------------------------------------------------------------------
 system.version                                 0.00 MB   0.00:1 snappy        0.03 MB        0.01 MB (37.5%)              1
----------------------------------------------------------------------------------------------------------------------------
View(s):	0                              
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                           0.00 MB          0.01:1        0.06 MB        0.02 MB (37.5%)              3
Indexes subtotal:                                                              0.06 MB        0.02 MB (37.5%)
============================================================================================================================

============================================================================================================================
Database: config                              Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collection(s):	3                        
----------------------------------------------------------------------------------------------------------------------------
 system.indexBuilds                             0.00 MB   0.00:1 snappy        0.01 MB        0.00 MB (33.3%)              0
----------------------------------------------------------------------------------------------------------------------------
 system.sessions                                0.00 MB   0.00:1 snappy        0.04 MB        0.02 MB (44.4%)              1
----------------------------------------------------------------------------------------------------------------------------
 transactions                                   0.00 MB   0.00:1 snappy        0.00 MB        0.00 MB  (0.0%)              0
----------------------------------------------------------------------------------------------------------------------------
View(s):	0                              
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                           0.00 MB          0.00:1        0.05 MB        0.02 MB (38.5%)              1
Indexes subtotal:                                                              0.07 MB        0.04 MB (47.4%)
============================================================================================================================

============================================================================================================================
Database: database                            Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collection(s):	1                        
----------------------------------------------------------------------------------------------------------------------------
 collection                                    25.22 MB   2.07:1   zstd       12.21 MB        0.00 MB  (0.0%)          37061
----------------------------------------------------------------------------------------------------------------------------
View(s):	0                              
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                          25.22 MB          2.16:1       11.66 MB        0.00 MB  (0.0%)          37061
Indexes subtotal:                                                              5.13 MB        0.01 MB  (0.2%)
============================================================================================================================

============================================================================================================================
Database: local                               Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
Collection(s):	8                        
----------------------------------------------------------------------------------------------------------------------------
 oplog.rs                                     186.46 MB   1.90:1 snappy      195.57 MB       97.48 MB (49.8%)         231759
----------------------------------------------------------------------------------------------------------------------------
 replset.election                               0.00 MB   0.00:1 snappy        0.04 MB        0.02 MB (44.4%)              1
----------------------------------------------------------------------------------------------------------------------------
 replset.initialSyncId                          0.00 MB   0.00:1 snappy        0.03 MB        0.01 MB (37.5%)              1
----------------------------------------------------------------------------------------------------------------------------
 replset.minvalid                               0.00 MB   0.00:1 snappy        0.04 MB        0.02 MB (44.4%)              1
----------------------------------------------------------------------------------------------------------------------------
 replset.oplogTruncateAfterPoint                0.00 MB   0.00:1 snappy        0.04 MB        0.02 MB (44.4%)              1
----------------------------------------------------------------------------------------------------------------------------
 startup_log                                    0.08 MB   2.92:1 snappy        0.05 MB        0.02 MB (46.2%)             27
----------------------------------------------------------------------------------------------------------------------------
 system.replset                                 0.00 MB   0.04:1 snappy        0.04 MB        0.02 MB (44.4%)              1
----------------------------------------------------------------------------------------------------------------------------
 system.rollback.id                             0.00 MB   0.00:1 snappy        0.03 MB        0.01 MB (37.5%)              1
----------------------------------------------------------------------------------------------------------------------------
View(s):	0                              
----------------------------------------------------------------------------------------------------------------------------
Collections subtotal:                         181.33 MB          1.43:1      224.29 MB       97.59 MB (43.5%)         225946
Indexes subtotal:                                                              0.22 MB        0.09 MB (38.6%)
============================================================================================================================

============================================================================================================================
dbPath totals                                 Data size     Compression   Size on disk    Free blocks (reuse)   Object count
----------------------------------------------------------------------------------------------------------------------------
All DBs:                                      206.54 MB          1.49:1      236.06 MB       97.64 MB (41.4%)         263011
All indexes:                                                                   5.48 MB        0.16 MB  (2.8%)
============================================================================================================================
Host: hostname.example.org 	Type: mongod 	DbPath: /data/replset/rs1/db
============================================================================================================================
```
