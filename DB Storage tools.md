# DB storage tools

## Storage engine usage reporting

This script is primarily designed to evaluate disk utilisation (including "_fragmentation_") for DB maintainance and for capacity planning tasks.

The [dbstats.js](src/dbstats.js) script (and [mdblib.js](src/mdblib.js) dependency) provides a basic tabular report of DB internal storage and some dervied metrics:

* Data size (uncompressed)
* Storage size (on disk)
* Document count
* Orphaned document count
* Free blocks (reclaimable/reusable space)
* Compression statistics
* Index storage and reusable space

### Installing _dbstats.js_

Retrieve fresh versions of both the _dbstats.js_ and _mdblib.js_ scripts:

```bash
curl --remote-name-all -fsSL https://raw.githubusercontent.com/tap1r/mongodb-scripts/master/src/{dbstats.js,mdblib.js}
```

### Using _dbstats.js_

Sample syntax to run against either of the _mongo_ or _mongosh_ shells:

```bash
[mongo|mongosh] [connection options] --quiet dbstats.js
```

### Prerequisites

1. Requires the legacy `mongo` shell v4.2+, or `mongosh` v1.x+
2. Add [mdblib.js](src/mdblib.js) dependency to the `cwd` or `$MDBLIB` path
3. Ensure _authorized_ users have the following minimum required roles `readAnyDatabase@admin` and `clusterMonitor@admin`

   In the Atlas UI this translates as:
   * Built-in Role: _Only read any database_
   * Specific Privileges: _clusterMonitor_
 
   Or:
   * Custom role:
     * Global Actions and Roles 
       - Built-In Roles
         - _clusterMonitor_
         - _readAnyDatabase_

### Sample output

```text
======================================================================================================================================
Database: admin                               Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections (visible): 0
--------------------------------------------------------------------------------------------------------------------------------------
Views (visible):       0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal:   4                        0.01 MB          0.11:1        0.14 MB        0.06 MB (44.4%)             34         0
Indexes subtotal:      6                                                       0.21 MB           0 MB    (0%)
======================================================================================================================================


======================================================================================================================================
Database: config                              Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections (visible): 6
 -------------------------------------------------------------------------------------------------------------------------------------
 transactions                                      0 MB      0:1 snappy        0.04 MB        0.03 MB (77.8%)              0         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.04 MB        0.03 MB (77.8%)
  ------------------------------------------------------------------------------------------------------------------------------------
  parent_lsid                                                                     0 MB           0 MB    (0%)
 -------------------------------------------------------------------------------------------------------------------------------------
 tenantMigrationDonors                             0 MB      0:1 snappy           0 MB           0 MB    (0%)              0         0
  ------------------------------------------------------------------------------------------------------------------------------------
  TenantMigrationDonorTTLIndex                                                    0 MB           0 MB    (0%)
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                            0 MB           0 MB    (0%)
 -------------------------------------------------------------------------------------------------------------------------------------
 image_collection                                  0 MB      0:1 snappy           0 MB           0 MB    (0%)              0         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                            0 MB           0 MB    (0%)
 -------------------------------------------------------------------------------------------------------------------------------------
 external_validation_keys                          0 MB      0:1 snappy           0 MB           0 MB    (0%)              0         0
  ------------------------------------------------------------------------------------------------------------------------------------
  ExternalKeysTTLIndex                                                            0 MB           0 MB    (0%)
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                            0 MB           0 MB    (0%)
 -------------------------------------------------------------------------------------------------------------------------------------
 user_writes_critical_sections                     0 MB      0:1 snappy        0.03 MB        0.02 MB   (75%)              0         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.03 MB        0.02 MB   (75%)
 -------------------------------------------------------------------------------------------------------------------------------------
 tenantMigrationRecipients                         0 MB      0:1 snappy           0 MB           0 MB    (0%)              0         0
  ------------------------------------------------------------------------------------------------------------------------------------
  TenantMigrationRecipientTTLIndex                                                0 MB           0 MB    (0%)
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                            0 MB           0 MB    (0%)
--------------------------------------------------------------------------------------------------------------------------------------
Views (visible):       0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal:   9                           0 MB          0.46:1        0.15 MB        0.14 MB (92.3%)             37         0
Indexes subtotal:      13                                                       0.2 MB        0.05 MB (25.5%)
======================================================================================================================================


======================================================================================================================================
Database: database                            Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections (visible): 1
 -------------------------------------------------------------------------------------------------------------------------------------
 collection                                    194.9 MB     2.47:1 zstd       80.54 MB        1.58 MB    (2%)         213620         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         9.61 MB        4.61 MB   (48%)
  ------------------------------------------------------------------------------------------------------------------------------------
  array_1                                                                     59.95 MB       38.17 MB (63.7%)
  ------------------------------------------------------------------------------------------------------------------------------------
  date_-1                                                                      6.83 MB           3 MB (43.9%)
  ------------------------------------------------------------------------------------------------------------------------------------
  date_1                                                                       6.43 MB        2.56 MB (39.8%)
  ------------------------------------------------------------------------------------------------------------------------------------
  geoCollection_2dsphere                                                      10.46 MB        0.87 MB  (8.3%)
  ------------------------------------------------------------------------------------------------------------------------------------
  language_1_schema_1                                                          6.06 MB        1.22 MB (20.2%)
  ------------------------------------------------------------------------------------------------------------------------------------
  lineString_2dsphere                                                         22.96 MB       17.41 MB (75.8%)
  ------------------------------------------------------------------------------------------------------------------------------------
  location.coordinates_2d                                                      1.55 MB        1.11 MB (71.1%)
  ------------------------------------------------------------------------------------------------------------------------------------
  location_2dsphere                                                            1.41 MB        0.93 MB (65.5%)
  ------------------------------------------------------------------------------------------------------------------------------------
  multiLineString_2dsphere                                                    10.29 MB        0.66 MB  (6.4%)
  ------------------------------------------------------------------------------------------------------------------------------------
  multiPoint_2dsphere                                                          2.04 MB        0.07 MB  (3.3%)
  ------------------------------------------------------------------------------------------------------------------------------------
  multiPolygon_2dsphere                                                        8.84 MB        0.58 MB  (6.5%)
  ------------------------------------------------------------------------------------------------------------------------------------
  object.$**_1                                                                60.63 MB       33.57 MB (55.4%)
  ------------------------------------------------------------------------------------------------------------------------------------
  polygonMulti_2dsphere                                                        7.21 MB        0.45 MB  (6.3%)
  ------------------------------------------------------------------------------------------------------------------------------------
  polygon_2dsphere                                                             8.95 MB        0.66 MB  (7.3%)
  ------------------------------------------------------------------------------------------------------------------------------------
  quote.txt_text                                                              16.16 MB        8.94 MB (55.3%)
  ------------------------------------------------------------------------------------------------------------------------------------
  random_1                                                                    11.51 MB        6.38 MB (55.4%)
  ------------------------------------------------------------------------------------------------------------------------------------
  string_hashed                                                               11.43 MB        6.71 MB (58.7%)
  ------------------------------------------------------------------------------------------------------------------------------------
  timestamp_1                                                                  6.86 MB        2.78 MB (40.5%)
--------------------------------------------------------------------------------------------------------------------------------------
Views (visible):       1
--------------------------------------------------------------------------------------------------------------------------------------
 myCollectionView
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal:   2                       194.9 MB          2.52:1       80.57 MB        3.17 MB  (3.9%)         213621         0
Indexes subtotal:      20                                                    269.21 MB      130.66 MB (48.5%)
======================================================================================================================================


======================================================================================================================================
Database: encryption                          Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections (visible): 1
 -------------------------------------------------------------------------------------------------------------------------------------
 __keyVault                                        0 MB      0:1 snappy           0 MB           0 MB    (0%)              0         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                            0 MB           0 MB    (0%)
  ------------------------------------------------------------------------------------------------------------------------------------
  keyAltNames_1                                                                   0 MB           0 MB    (0%)
--------------------------------------------------------------------------------------------------------------------------------------
Views (visible):       0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal:   1                           0 MB             0:1           0 MB           0 MB    (0%)              0         0
Indexes subtotal:      2                                                       0.01 MB           0 MB    (0%)
======================================================================================================================================


======================================================================================================================================
Database: local                               Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections (visible): 3
 -------------------------------------------------------------------------------------------------------------------------------------
 oplog.rs                                     981.04 MB   2.29:1 snappy      633.93 MB      205.63 MB (32.4%)        1969942         0
 -------------------------------------------------------------------------------------------------------------------------------------
 startup_log                                    0.36 MB   5.87:1 snappy        0.09 MB        0.03 MB (30.4%)            105         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.04 MB        0.02 MB (44.4%)
 -------------------------------------------------------------------------------------------------------------------------------------
 clustermanager                                    0 MB   0.01:1 snappy        0.04 MB        0.02 MB (44.4%)              1         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.03 MB        0.01 MB (37.5%)
--------------------------------------------------------------------------------------------------------------------------------------
Views (visible):       1
--------------------------------------------------------------------------------------------------------------------------------------
 system.tenantMigration.oplogView
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal:   10                     981.41 MB           4.4:1      634.29 MB      411.43 MB (64.9%)        1970055         0
Indexes subtotal:      9                                                       0.27 MB        0.03 MB   (10%)
======================================================================================================================================


======================================================================================================================================
Database: sample_airbnb                       Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections (visible): 2
 -------------------------------------------------------------------------------------------------------------------------------------
 listingsAndReviews                            89.99 MB   1.73:1 snappy       51.93 MB        0.04 MB  (0.1%)           5555         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                          0.2 MB        0.01 MB  (5.9%)
  ------------------------------------------------------------------------------------------------------------------------------------
  address.location_2dsphere                                                     0.1 MB        0.01 MB (11.5%)
  ------------------------------------------------------------------------------------------------------------------------------------
  name_1                                                                       0.25 MB        0.01 MB  (4.6%)
  ------------------------------------------------------------------------------------------------------------------------------------
  property_type_1_room_type_1_beds_1                                           0.06 MB        0.01 MB   (20%)
 -------------------------------------------------------------------------------------------------------------------------------------
 listingsAndReviewsCSV                         89.99 MB   1.74:1 snappy       51.65 MB        0.05 MB  (0.1%)           5555         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.18 MB        0.01 MB  (6.5%)
--------------------------------------------------------------------------------------------------------------------------------------
Views (visible):       0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal:   2                      179.98 MB          1.74:1      103.59 MB         0.2 MB  (0.2%)          11110         0
Indexes subtotal:      5                                                       0.79 MB        0.06 MB  (7.4%)
======================================================================================================================================


======================================================================================================================================
Database: sample_geospatial                   Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections (visible): 1
 -------------------------------------------------------------------------------------------------------------------------------------
 shipwrecks                                     3.48 MB   4.88:1 snappy        0.73 MB        0.01 MB  (1.6%)          11095         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.12 MB        0.01 MB  (9.7%)
  ------------------------------------------------------------------------------------------------------------------------------------
  coordinates_2dsphere                                                          0.2 MB        0.01 MB  (5.9%)
--------------------------------------------------------------------------------------------------------------------------------------
Views (visible):       0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal:   1                        3.48 MB          4.96:1        0.73 MB        0.02 MB  (3.2%)          11095         0
Indexes subtotal:      2                                                       0.32 MB        0.02 MB  (7.3%)
======================================================================================================================================


======================================================================================================================================
Database: sample_mflix                        Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections (visible): 5
 -------------------------------------------------------------------------------------------------------------------------------------
 sessions                                          0 MB   0.03:1 snappy        0.03 MB        0.01 MB (37.5%)              1         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.03 MB        0.01 MB (37.5%)
  ------------------------------------------------------------------------------------------------------------------------------------
  user_id_1                                                                    0.03 MB        0.01 MB (37.5%)
 -------------------------------------------------------------------------------------------------------------------------------------
 comments                                      13.63 MB    1.8:1 snappy        7.58 MB        0.01 MB  (0.2%)          50304         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         1.46 MB        0.02 MB  (1.1%)
 -------------------------------------------------------------------------------------------------------------------------------------
 users                                          0.03 MB   0.83:1 snappy        0.05 MB        0.01 MB   (25%)            185         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.03 MB        0.01 MB (37.5%)
  ------------------------------------------------------------------------------------------------------------------------------------
  email_1                                                                      0.04 MB        0.01 MB (33.3%)
 -------------------------------------------------------------------------------------------------------------------------------------
 theaters                                       0.33 MB    2.2:1 snappy        0.16 MB        0.01 MB  (7.1%)           1564         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.09 MB        0.01 MB (13.6%)
  ------------------------------------------------------------------------------------------------------------------------------------
  geo index                                                                    0.05 MB        0.01 MB (23.1%)
 -------------------------------------------------------------------------------------------------------------------------------------
 movies                                         35.9 MB   1.72:1 snappy       21.17 MB        0.32 MB  (1.5%)          23539         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.54 MB        0.02 MB  (2.9%)
  ------------------------------------------------------------------------------------------------------------------------------------
  cast_text_fullplot_text_genres_text_title_text                              12.95 MB        0.01 MB  (0.1%)
--------------------------------------------------------------------------------------------------------------------------------------
Views (visible):       0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal:   5                        49.9 MB          1.77:1       28.99 MB        0.73 MB  (2.5%)          75593         0
Indexes subtotal:      9                                                      15.21 MB        0.11 MB  (0.7%)
======================================================================================================================================


======================================================================================================================================
Database: sample_supplies                     Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections (visible): 1
 -------------------------------------------------------------------------------------------------------------------------------------
 sales                                          4.13 MB    4.7:1 snappy        0.89 MB        0.01 MB  (1.3%)           5000         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.07 MB        0.01 MB (16.7%)
--------------------------------------------------------------------------------------------------------------------------------------
Views (visible):       0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal:   1                        4.13 MB          4.77:1        0.89 MB        0.02 MB  (2.6%)           5000         0
Indexes subtotal:      1                                                       0.07 MB        0.01 MB (16.7%)
======================================================================================================================================


======================================================================================================================================
Database: sample_training                     Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections (visible): 9
 -------------------------------------------------------------------------------------------------------------------------------------
 trips                                           4.2 MB   3.56:1 snappy        1.19 MB        0.01 MB    (1%)          10000         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.53 MB        0.01 MB  (2.2%)
 -------------------------------------------------------------------------------------------------------------------------------------
 tweets                                        39.39 MB   2.48:1 snappy       15.93 MB        0.04 MB  (0.2%)          24832         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.36 MB        0.01 MB  (3.3%)
 -------------------------------------------------------------------------------------------------------------------------------------
 routes                                        11.76 MB   5.32:1 snappy        2.23 MB        0.02 MB    (1%)          66985         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         1.52 MB        0.02 MB  (1.3%)
 -------------------------------------------------------------------------------------------------------------------------------------
 companies                                     34.79 MB   2.22:1 snappy        15.7 MB        0.01 MB  (0.1%)           9500         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.15 MB        0.01 MB  (7.7%)
 -------------------------------------------------------------------------------------------------------------------------------------
 grades                                        22.22 MB   3.12:1 snappy        7.15 MB        0.03 MB  (0.4%)         100000         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         2.59 MB        0.03 MB  (1.1%)
 -------------------------------------------------------------------------------------------------------------------------------------
 posts                                         16.64 MB   3.98:1 snappy        4.19 MB        0.01 MB  (0.3%)            500         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.05 MB        0.01 MB (23.1%)
 -------------------------------------------------------------------------------------------------------------------------------------
 stories                                        9.62 MB   2.11:1 snappy        4.58 MB        0.01 MB  (0.3%)           9842         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.11 MB        0.01 MB (10.7%)
  ------------------------------------------------------------------------------------------------------------------------------------
  diggs_1                                                                      0.09 MB        0.01 MB (13.6%)
 -------------------------------------------------------------------------------------------------------------------------------------
 zips                                           3.13 MB   2.04:1 snappy        2.23 MB         0.7 MB (31.1%)          29470         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.51 MB        0.01 MB  (2.3%)
 -------------------------------------------------------------------------------------------------------------------------------------
 inspections                                   21.13 MB   2.39:1 snappy        8.86 MB        0.04 MB  (0.4%)          80047         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                          1.4 MB        0.02 MB  (1.1%)
--------------------------------------------------------------------------------------------------------------------------------------
Views (visible):       0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal:   9                      162.88 MB           2.7:1       62.08 MB        1.73 MB  (2.8%)         331176         0
Indexes subtotal:      10                                                       7.3 MB        0.14 MB    (2%)
======================================================================================================================================


======================================================================================================================================
Database: sample_weatherdata                  Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
Collections (visible): 1
 -------------------------------------------------------------------------------------------------------------------------------------
 data                                          16.15 MB   5.55:1 snappy        2.93 MB        0.02 MB  (0.5%)          10000         0
  ------------------------------------------------------------------------------------------------------------------------------------
  _id_                                                                         0.25 MB        0.01 MB  (4.6%)
--------------------------------------------------------------------------------------------------------------------------------------
Views (visible):       0
--------------------------------------------------------------------------------------------------------------------------------------
Namespaces subtotal:   1                       16.15 MB          5.58:1        2.93 MB        0.03 MB  (1.1%)          10000         0
Indexes subtotal:      1                                                       0.25 MB        0.01 MB  (4.6%)
======================================================================================================================================


======================================================================================================================================
dbPath totals                                 Data size     Compression   Size on disk    Free blocks (reuse)   Object count   Orphans
--------------------------------------------------------------------------------------------------------------------------------------
All namespaces:        45                    1592.83 MB          3.21:1      914.35 MB      417.55 MB (45.7%)        2627721         0
All indexes:           78                                                    293.86 MB      131.11 MB (44.6%)
======================================================================================================================================
Host: hostname.example.org	Type: mongod	Version: 6.3.2	dbPath: /data/replset/rs1/db
======================================================================================================================================
```
